<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jogo da Forca</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script type="module" src="supabaseClient.js"></script>
    <script type="module" src="utils.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;600&family=Orbitron:wght@700;900&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="forca.css">
</head>
<body>

    <div id="tela-inicio">
        <h1>Bem-vindo ao Jogo da Forca!</h1>
        <button id="botao-iniciar">Come√ßar Jogo</button>
        <button id="btnVoltarMural">Voltar para o Mural</button>

        <div id="menu-ranking">
            <h2>üèÜ Top 5 üèÜ</h2>
            <div id="ranking-board-menu">
                <p>Carregando ranking...</p>
            </div>
        </div>
    </div>

    <div id="jogo-principal" class="hidden">
        <h1>Jogo da Forca</h1>
        <div class="jogo-container">
            <div class="forca-container">
                <svg height="250" width="200" class="forca">
                    <line x1="60" y1="20" x2="140" y2="20" />
                    <line x1="140" y1="20" x2="140" y2="50" />
                    <line x1="60" y1="20" x2="60" y2="230" />
                    <line x1="20" y1="230" x2="100" y2="230" />

                    <circle cx="140" cy="70" r="20" class="homem-parte" /> <line x1="140" y1="90" x2="140" y2="150" class="homem-parte" /> <line x1="140" y1="120" x2="110" y2="100" class="homem-parte" /> <line x1="140" y1="120" x2="170" y2="100" class="homem-parte" /> <line x1="140" y1="150" x2="110" y2="180" class="homem-parte" /> <line x1="140" y1="150" x2="170" y2="180" class="homem-parte" /> </svg>
            </div>
            <div id="palavra-container"></div>
            <div id="teclado"></div>
            <div id="mensagem"></div>
            <button id="btnTelaInicial">Tela Inicial</button>
            <button id="botao-reiniciar">Jogar Novamente</button>
        </div>
    </div>

    <script>
        const telaInicio = document.getElementById('tela-inicio');
        const jogoPrincipal = document.getElementById('jogo-principal');
        const botaoIniciar = document.getElementById('botao-iniciar');
        const palavraContainer = document.getElementById('palavra-container');
        const tecladoContainer = document.getElementById('teclado');
        const mensagemEl = document.getElementById('mensagem');
        const botaoReiniciar = document.getElementById('botao-reiniciar');
        const homemPartes = document.querySelectorAll('.homem-parte');
        const btnVoltarMural = document.getElementById("btnVoltarMural");
        const btnTelaInicial = document.getElementById("btnTelaInicial");

        let palavraSelecionada = '';
        let letrasCorretas = [];
        let letrasErradas = [];
        let score = 0;
        let palavras = [
            "bruna marquezine", "neymar jr.", "anitta", "tata werneck", "giovanna ewbank", 
            "caio castro", "juliana paes", "marina ruy barbosa", "ludmilla", "thais fersoza",
            "paolla oliveira", "rodrigo santoro", "juliana alves", "isis valverde", "camila queiroz", 
            "lucas lucco", "gusttavo lima", "ivete sangalo", "mirella santos", "mateus solano", 
            "luciano huck", "xuxa meneghel", "larissa manoela", "kefera buchmann", "tati zaqui", 
            "pabllo vittar", "nanda costa", "fabio assuncao", "deborah secco", "marcos mion", 
            "paloma bernardi", "daniela albuquerque", "mario frias", "jose loreto", "renata dominguez", 
            "caua reymond", "gloria pires", "luana piovani", "felipe titolo", "leo picon", 
            "luiz lins", "nathalia dill", "ricardo pereira", "tatiane lobo", "andressa suita", 
            "roberta rodrigues", "simone mendes", "simaria", "rafa kalimann", "biel", 
            "jade picon", "sabrina sato", "fatima bernardes", "felipe neto", "gabriela pugliesi"
        ];

        function iniciarJogo() {
            telaInicio.classList.add('hidden');
            jogoPrincipal.classList.remove('hidden');
            prepararNovoJogo();
        }

        function prepararNovoJogo() {
            palavraSelecionada = palavras[Math.floor(Math.random() * palavras.length)];
            letrasCorretas = [];
            letrasErradas = [];
            score = 0;
            mensagemEl.innerText = '';
            botaoReiniciar.style.display = 'none';

            // CORRE√á√ÉO: Esconde o boneco removendo a classe .show
            homemPartes.forEach(parte => parte.classList.remove('show'));
            
            mostrarPalavra();
            criarTeclado();
        }

        function mostrarPalavra() {
            palavraContainer.innerHTML = ` 
                ${palavraSelecionada
                    .split('') 
                    .map(letra => `<span class="letra">${letrasCorretas.includes(letra) || letra === ' ' || letra === '.' ? letra : '_'}</span>`)
                    .join('')}
            `;

            // NOVA VERIFICA√á√ÉO DE VIT√ìRIA - A FORMA CORRETA
            // Verifica se toda letra da palavra selecionada est√° inclusa nas letras corretas (ou √© espa√ßo/ponto)
            const vitoria = palavraSelecionada.split('').every(letra => 
                letrasCorretas.includes(letra) || letra === ' ' || letra === '.'
            );

            if (vitoria) {
                mensagemEl.innerText = 'Parab√©ns! Voc√™ venceu! üòÉ';
                finalizarJogo();
            }
        }

        // FUN√á√ÉO CORRIGIDA
        function atualizarErradas() {
            // Mostra as partes do boneco adicionando a classe .show
            homemPartes.forEach((parte, index) => {
                if (index < letrasErradas.length) {
                    parte.classList.add('show');
                }
            });

            // Verifica a condi√ß√£o de derrota
            if (letrasErradas.length === homemPartes.length) {
                mensagemEl.innerText = `Voc√™ perdeu! üòï A palavra era: ${palavraSelecionada}`;
                finalizarJogo();
            }
        }

        function criarTeclado() {
            const letras = 'abcdefghijklmnopqrstuvwxyz';
            tecladoContainer.innerHTML = '';
            for (let letra of letras) {
                const tecla = document.createElement('div');
                tecla.classList.add('tecla');
                tecla.innerText = letra;
                tecla.addEventListener('click', () => selecionarLetra(letra, tecla));
                tecladoContainer.appendChild(tecla);
            }
        }

        function selecionarLetra(letra, tecla) {
            if (tecla.classList.contains('usada')) return;
            
            tecla.classList.add('usada');

            if (palavraSelecionada.includes(letra)) {
                letrasCorretas.push(letra);
                tecla.classList.add('correta'); // Feedback visual de acerto
            } else {
                letrasErradas.push(letra);
                tecla.classList.add('errada'); // Feedback visual de erro
                // A fun√ß√£o atualizarErradas cuidar√° de desenhar o boneco
            }
            
            mostrarPalavra();
            atualizarErradas();
        }

        function finalizarJogo() {
            const teclas = document.querySelectorAll('.tecla');
            teclas.forEach(tecla => {
                if(!tecla.classList.contains('usada')) {
                    tecla.classList.add('usada');
                }
            });
            botaoReiniciar.style.display = 'block';

            const pontuacao = letrasCorretas.length * 10 - letrasErradas.length * 5; 
            const userId = 'user123'; // Este ID precisa ser um UUID v√°lido ou voc√™ ter√° um erro
            const nomeJogador = 'Jogador1'; // Substitua pelo nome do jogador real
            
        }

        async function salvarPontuacaoForca(userId, nomeJogador, pontuacao) {
    if (!window._supabase) {
        console.error("Supabase client n√£o encontrado.");
        return;
    }

    // Objeto de dados que corresponde EXATAMENTE √† sua tabela
    const dadosParaSalvar = {
        // 'id' pode ser omitido se for gerado automaticamente pelo Supabase
        user_id: userId, // Supondo que voc√™ queira usar o userId aqui
        score: pontuacao,
        tries: letrasErradas.length, // Salvando o n√∫mero de tentativas erradas
        word: palavraSelecionada // Salvando a palavra do jogo
    };

    try {
        // Usaremos 'insert' em vez de 'upsert' por ser mais simples aqui
        const { error } = await window._supabase
            .from('forca_scores') // Removido as aspas duplas desnecess√°rias
            .insert([dadosParaSalvar]);

        if (error) {
            console.error('Erro ao salvar pontua√ß√£o:', error);
            // Um erro comum aqui √© violar a chave 'user_id' se ela n√£o for √∫nica
            // ou se o 'id' que voc√™ est√° tentando inserir j√° existir.
            return;
        }

        console.log('Pontua√ß√£o salva com sucesso!', dadosParaSalvar);
        // Recarregar o ranking para mostrar a nova pontua√ß√£o
        carregarRankingForca(); 
    } catch (error) {
        console.error('Erro inesperado ao salvar pontua√ß√£o:', error);
    }
}

        async function carregarRankingForca() {
            // Verifique se a vari√°vel _supabase est√° dispon√≠vel
            if (!window._supabase) {
                console.error("Supabase client n√£o encontrado. Verifique a importa√ß√£o.");
                const rankingBoardMenu = document.getElementById('ranking-board-menu');
                if (rankingBoardMenu) {
                    rankingBoardMenu.innerHTML = '<p>Erro de conex√£o com o placar.</p>';
                }
                return;
            }
            
            const rankingBoardMenu = document.getElementById('ranking-board-menu');
    if (!rankingBoardMenu) return;

    // Pedindo as colunas corretas: 'user_id' e 'score'
    const { data, error } = await window._supabase
        .from('forca_scores')
        .select('user_id, score') // MUDAN√áA AQUI
        .order('score', { ascending: false }) // MUDAN√áA AQUI
        .limit(5);

    if (error) {
        console.error('Erro ao carregar o ranking:', error);
        rankingBoardMenu.innerHTML = '<p>N√£o foi poss√≠vel carregar o ranking. Tente novamente.</p>';
        return;
    }

    if (data.length === 0) {
        rankingBoardMenu.innerHTML = '<p>Seja o primeiro a deixar sua marca!</p>';
        return;
    }

    const rankingList = document.createElement('ol');
    data.forEach((entry, index) => {
        // Usando as colunas que realmente existem: entry.user_id e entry.score
        const playerName = entry.user_id || 'An√¥nimo'; // Exibindo o ID do usu√°rio
        const listItem = document.createElement('li');
        listItem.innerHTML = `<span>#${index + 1} ${playerName}</span> <span>${entry.score} pts</span>`; // MUDAN√áA AQUI
        rankingList.appendChild(listItem);
    });

    rankingBoardMenu.innerHTML = '';
    rankingBoardMenu.appendChild(rankingList);
}

        botaoIniciar.addEventListener('click', iniciarJogo);
        botaoReiniciar.addEventListener('click', prepararNovoJogo);
        btnVoltarMural.addEventListener("click", function () {
            window.location.href = "mural.html";  
        });

        btnTelaInicial.addEventListener("click", function () {
            // Recarrega a p√°gina atual para voltar ao in√≠cio do jogo da forca
            window.location.reload();
        });

        // Carrega o ranking quando a p√°gina √© aberta
        document.addEventListener('DOMContentLoaded', carregarRankingForca);

    </script>

</body>
</html>
