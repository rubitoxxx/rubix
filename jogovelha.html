<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jogo da Velha - Rubix</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Estilos do ranking e lobby online (mantidos do seu código original) */
        #ranking-section { margin-bottom: 30px; text-align: center; }
        #ranking-board ol { list-style: none; padding: 0; }
        #ranking-board li { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid var(--cor-primaria); font-size: 1.1em; text-align: left; }
        #ranking-board li:last-child { border-bottom: none; }
        #game-code-display { margin: 20px 0; font-size: 1.2em; text-align: center; }
        #game-code-display span { background: #333; padding: 5px 10px; border-radius: 5px; cursor: pointer; }
        #online-lobby-view input { padding: 10px; font-size: 1em; margin-right: 10px; }
        #reset-button, #back-to-menu-button { margin-top: 20px; }

        /* Adicione ou ajuste estilos para o tabuleiro se necessário, garantindo boa visualização */
        #game-board {
            display: grid;
            grid-template-columns: repeat(3, 100px);
            grid-template-rows: repeat(3, 100px);
            gap: 5px;
            width: 315px; /* 3*100px + 2*5px */
            margin: 20px auto;
            background-color: #222;
            border-radius: 8px;
            padding: 5px;
        }

        .cell {
            width: 100px;
            height: 100px;
            background-color: var(--cor-secundaria);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 3em;
            font-weight: bold;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.2s ease-in-out;
        }

        .cell:hover {
            background-color: #444;
        }

        .x {
            color: #ff6b6b; /* Cor para o jogador X */
        }

        .o {
            color: #6bff6b; /* Cor para a máquina O */
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Jogo da Velha</h1>

        <div id="main-menu-view">
            <div id="ranking-section">
                <h2><i class="fas fa-trophy"></i> Ranking</h2>
                <div id="ranking-board"><p>Carregando ranking...</p></div>
            </div>
            <div id="mode-selection">
                <button class="btn" onclick="selecionarModo('computer')">Jogar contra a Máquina</button>
                <button class="btn" onclick="selecionarModo('online')">Jogar Online</button>
            </div>
            <a href="mural.html" class="btn secondary" style="margin-top: 20px;">Voltar ao Mural</a>
        </div>
        
        <div id="online-lobby-view" style="display: none;">
            <h2>Modo Online</h2>
            <div id="create-game-section">
                <button class="btn" onclick="criarNovoJogo()">Criar Novo Jogo</button>
            </div>
            <hr style="margin: 20px 0;">
            <div id="join-game-section">
                <input type="text" id="game-code-input" placeholder="Cole o código do jogo aqui">
                <button class="btn secondary" onclick="entrarEmJogo()">Entrar no Jogo</button>
            </div>
            <button class="btn secondary" style="margin-top: 20px;" onclick="voltarParaMenuPrincipal()">Voltar</button>
        </div>

        <div id="game-view" style="display: none;">
            <div id="game-code-display"></div>
            <div id="game-board"></div>
            <div id="status"></div>
            <button id="reset-button" style="display:none;"></button>
            <button id="back-to-menu-button" class="btn secondary" onclick="location.reload()">Menu Principal</button>
        </div>
    </div>

    <script>
        // --- INICIALIZAÇÃO E VARIÁVEIS GLOBAIS ---
        const supabaseUrl = 'https://ldrcfomamlzpxoucpkmb.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxkcmNmb21hbWx6cHhvdWNwa21iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE4MjA4MjksImV4cCI6MjA2NzM5NjgyOX0.jsqMGgsa9qOMVQvX7bdS70lFvJ7f7TEpm3ggEtV-tL0';
        const { createClient } = supabase;
        const _supabase = createClient(supabaseUrl, supabaseKey);

        const mainMenu = document.getElementById('main-menu-view');
        const onlineLobby = document.getElementById('online-lobby-view');
        const gameView = document.getElementById('game-view');
        const gameBoard = document.getElementById('game-board');
        const statusDisplay = document.getElementById('status');
        const resetButton = document.getElementById('reset-button');
        const rankingBoard = document.getElementById('ranking-board');
        const gameCodeDisplay = document.getElementById('game-code-display');
        
        let currentUser = null;
        let gameMode = null;
        const winningConditions = [ [0, 1, 2], [3, 4, 5], [6, 7, 8], [0, 3, 6], [1, 4, 7], [2, 5, 8], [0, 4, 8], [2, 4, 6] ];

        // Variáveis para jogo online
        let currentGame = null;
        let gameSubscription = null;

        // Variáveis para jogo vs. Máquina
        let localGameActive = true;
        let localCurrentPlayer = 'X'; // Sempre começa com o jogador humano
        let localGameState = ['', '', '', '', '', '', '', '', ''];
        
        document.addEventListener('DOMContentLoaded', async () => {
            const { data: { session } } = await _supabase.auth.getSession();
            if (!session) { window.location.href = 'index.html'; return; }
            currentUser = session.user;
            await carregarRanking();
        });

        function selecionarModo(mode) {
            gameMode = mode;
            mainMenu.style.display = 'none';
            if (mode === 'online') {
                onlineLobby.style.display = 'block';
            } else if (mode === 'computer') {
                iniciarJogoLocal();
            }
        }
        
        function voltarParaMenuPrincipal() {
            onlineLobby.style.display = 'none';
            mainMenu.style.display = 'block';
        }

        async function carregarRanking() {
            const { data, error } = await _supabase.from('game_scores').select(`wins, profiles(username)`).order('wins', { ascending: false }).limit(5);
            if (error || !data) { rankingBoard.innerHTML = '<p>Não foi possível carregar o ranking.</p>'; return; }
            if (data.length === 0) { rankingBoard.innerHTML = '<p>Ninguém venceu ainda. Seja o primeiro!</p>'; return; }
            const rankingList = document.createElement('ol');
            data.forEach((score, index) => {
                const playerUsername = score.profiles ? score.profiles.username : 'Anônimo';
                const listItem = document.createElement('li');
                listItem.innerHTML = `<span>#${index + 1} ${playerUsername}</span> <span>${score.wins} vitórias</span>`;
                rankingList.appendChild(listItem);
            });
            rankingBoard.innerHTML = '';
            rankingBoard.appendChild(rankingList);
        }

        async function registrarVitoria() {
            if (!currentUser) return;
            // A mensagem de vitória é tratada na validação do jogo, aqui apenas registramos o ponto.
            const { error } = await _supabase.rpc('increment_wins', { user_id_to_update: currentUser.id });
            if (error) console.error('Erro ao registrar vitória:', error);
            else await carregarRanking();
        }

        // --- LÓGICA DO JOGO ONLINE ---
        async function criarNovoJogo() {
            const { data, error } = await _supabase.from('games').insert({ player1_id: currentUser.id }).select().single();
            if (error) { console.error("Erro ao criar jogo:", error); return; }
            currentGame = data;
            iniciarVisualizacaoDeJogo();
            escutarMudancasNoJogo(currentGame.id);
        }

       async function entrarEmJogo() {
            const gameId = document.getElementById('game-code-input').value.trim();
            if (!gameId) {
                alert("Por favor, insira um código de jogo.");
                return;
            }

            const { data, error } = await _supabase.from('games')
                .update({ player2_id: currentUser.id, status: 'in_progress' })
                .eq('id', gameId)
                .eq('status', 'waiting')
                .is('player2_id', null)
                .select()
                .single();

            if (error || !data) {
                console.error("Erro ao tentar entrar no jogo:", error);
                if (error && error.message.includes('duplicate key value')) {
                    alert("Este jogo já tem dois jogadores ou o código está incorreto.");
                } else if (error && error.code === 'PGRST116') { // Código para "Row not found"
                    alert("Código de jogo inválido ou o jogo não está mais disponível para entrada.");
                } else {
                    alert("Não foi possível entrar no jogo. Verifique o código ou tente novamente.");
                }
                return;
            }

            currentGame = data;
            iniciarVisualizacaoDeJogo();
            escutarMudancasNoJogo(currentGame.id);
        }

        function iniciarVisualizacaoDeJogo() {
            onlineLobby.style.display = 'none';
            gameView.style.display = 'block';
            gameCodeDisplay.innerHTML = `Código do Jogo: <span onclick="copiarCodigo()">${currentGame.id}</span> (clique para copiar)`;
            resetButton.style.display = 'none'; // No jogo online, o reset é via recarregamento para novo jogo
            desenharTabuleiroOnline();
            atualizarStatusOnline();
        }

        function copiarCodigo() { navigator.clipboard.writeText(currentGame.id).then(() => alert("Código copiado!")); }

        function escutarMudancasNoJogo(gameId) {
            if (gameSubscription) { gameSubscription.unsubscribe(); }
            gameSubscription = _supabase.channel(`game-${gameId}`).on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'games', filter: `id=eq.${gameId}` }, payload => {
                currentGame = payload.new;
                desenharTabuleiroOnline();
                atualizarStatusOnline();
            }).subscribe();
        }

        function desenharTabuleiroOnline() {
            gameBoard.innerHTML = '';
            currentGame.board_state.forEach((cellValue, index) => {
                const cell = document.createElement('div');
                cell.classList.add('cell');
                if (cellValue) cell.classList.add(cellValue.toLowerCase());
                cell.dataset.cellIndex = index;
                cell.textContent = cellValue;
                cell.addEventListener('click', () => fazerJogadaOnline(index));
                gameBoard.appendChild(cell);
            });
        }

        async function fazerJogadaOnline(index) {
            const mySymbol = currentUser.id === currentGame.player1_id ? 'X' : 'O';
            if (currentGame.status !== 'in_progress' || mySymbol !== currentGame.current_turn || currentGame.board_state[index] !== '') return;
            
            const newBoardState = [...currentGame.board_state];
            newBoardState[index] = mySymbol;
            
            const [isFinished, winnerSymbol] = verificarVencedor(newBoardState);
            let newStatus = 'in_progress', newWinnerId = null;

            if (isFinished) {
                newStatus = 'finished';
                if (winnerSymbol) newWinnerId = winnerSymbol === 'X' ? currentGame.player1_id : currentGame.player2_id;
            }
            
            const nextTurn = mySymbol === 'X' ? 'O' : 'X';
            const { error } = await _supabase.from('games').update({ board_state: newBoardState, current_turn: nextTurn, status: newStatus, winner_id: newWinnerId }).eq('id', currentGame.id);
            if (error) console.error("Erro ao fazer jogada:", error);
        }

        async function atualizarStatusOnline() {
            if (currentGame.status === 'finished') {
                resetButton.style.display = 'block';
                resetButton.textContent = 'Jogar Novamente';
                resetButton.onclick = () => location.reload(); // Recarrega para iniciar novo jogo ou voltar ao menu
                
                if (currentGame.winner_id) {
                    const venci = currentUser.id === currentGame.winner_id;
                    statusDisplay.textContent = venci ? 'Você venceu!' : 'Você perdeu!';
                    if (venci) await registrarVitoria();
                } else { 
                    statusDisplay.textContent = 'O jogo empatou!'; 
                }
            } else if (currentGame.status === 'in_progress') {
                const isMyTurn = (currentGame.current_turn === 'X' && currentUser.id === currentGame.player1_id) || (currentGame.current_turn === 'O' && currentUser.id === currentGame.player2_id);
                statusDisplay.textContent = isMyTurn ? 'É a sua vez!' : 'Aguardando jogada do oponente...';
            } else { 
                statusDisplay.textContent = 'Aguardando oponente...'; 
            }
        }

        // --- LÓGICA DO JOGO VS MÁQUINA (COM MINIMAX) ---
        function iniciarJogoLocal() {
            gameView.style.display = 'block';
            resetButton.style.display = 'block';
            resetButton.textContent = 'Reiniciar Jogo';
            resetButton.onclick = iniciarJogoLocal; // Reinicia o jogo local
            localGameActive = true;
            localCurrentPlayer = 'X'; // O jogador humano é sempre 'X'
            localGameState = ['', '', '', '', '', '', '', '', ''];
            statusDisplay.innerHTML = `Sua vez (X)`;
            gameBoard.innerHTML = '';
            for (let i = 0; i < 9; i++) {
                const cell = document.createElement('div');
                cell.classList.add('cell');
                cell.dataset.cellIndex = i;
                cell.addEventListener('click', handleCellClickLocal);
                gameBoard.appendChild(cell);
            }
        }

        function handleCellClickLocal(event) {
            const clickedCell = event.target;
            const clickedCellIndex = parseInt(clickedCell.getAttribute('data-cell-index'));

            // Só permite jogada se for a vez do jogador e a célula estiver vazia
            if (localGameState[clickedCellIndex] !== '' || !localGameActive || localCurrentPlayer !== 'X') {
                return;
            }

            // Realiza a jogada do jogador
            localGameState[clickedCellIndex] = 'X';
            clickedCell.innerHTML = 'X';
            clickedCell.classList.add('x');

            // Verifica o resultado após a jogada do jogador
            const [isFinished, winnerSymbol] = verificarVencedor(localGameState);

            if (isFinished) {
                localGameActive = false;
                if (winnerSymbol === 'X') {
                    statusDisplay.innerHTML = `Você venceu!`;
                    registrarVitoria();
                } else {
                    statusDisplay.innerHTML = `O jogo empatou!`;
                }
                return;
            }

            // Se o jogo não terminou, é a vez da máquina
            localCurrentPlayer = 'O'; // Define o jogador atual para a máquina
            statusDisplay.innerHTML = `Vez da máquina (O)`;
            setTimeout(makeComputerMove, 700); // Dá um pequeno delay para a jogada da máquina
        }

        // Algoritmo Minimax para a IA
        function minimax(board, depth, isMaximizingPlayer) {
            const [isFinished, winnerSymbol] = verificarVencedor(board);

            // Casos base (condições de término)
            if (isFinished) {
                if (winnerSymbol === 'O') return 100 - depth; // IA (O) vence: pontuação alta, penaliza jogadas mais longas
                if (winnerSymbol === 'X') return -100 + depth; // Jogador (X) vence: pontuação baixa, recompensa vitória mais rápida do jogador (pior para IA)
                return 0; // Empate
            }

            if (isMaximizingPlayer) { // Vez da IA ('O') - Quer maximizar a pontuação
                let bestScore = -Infinity;
                for (let i = 0; i < board.length; i++) {
                    if (board[i] === '') {
                        board[i] = 'O'; // Tenta a jogada da IA
                        let score = minimax(board, depth + 1, false); // Chama para o próximo turno (jogador, minimizando)
                        board[i] = ''; // Desfaz a jogada (backtracking)
                        bestScore = Math.max(bestScore, score);
                    }
                }
                return bestScore;
            } else { // Vez do Jogador ('X') - Quer minimizar a pontuação da IA (ou seja, maximizar a própria)
                let bestScore = Infinity;
                for (let i = 0; i < board.length; i++) {
                    if (board[i] === '') {
                        board[i] = 'X'; // Tenta a jogada do jogador
                        let score = minimax(board, depth + 1, true); // Chama para o próximo turno (IA, maximizando)
                        board[i] = ''; // Desfaz a jogada
                        bestScore = Math.min(bestScore, score);
                    }
                }
                return bestScore;
            }
        }

        // Função para a jogada da máquina usando Minimax
        function makeComputerMove() {
            if (!localGameActive) return;

            let bestScore = -Infinity;
            let bestMove = -1;

            // Percorre todas as células vazias para encontrar a melhor jogada
            for (let i = 0; i < localGameState.length; i++) {
                if (localGameState[i] === '') {
                    localGameState[i] = 'O'; // Tenta a jogada da máquina
                    // Chama o minimax assumindo que o próximo turno é do jogador (isMaximizingPlayer = false)
                    let score = minimax(localGameState, 0, false); 
                    localGameState[i] = ''; // Desfaz a jogada (importante para não alterar o estado real do tabuleiro para as próximas simulações)

                    if (score > bestScore) {
                        bestScore = score;
                        bestMove = i;
                    }
                }
            }
            
            // Realiza a melhor jogada encontrada
            const cellElement = document.querySelector(`.cell[data-cell-index='${bestMove}']`);
            localGameState[bestMove] = 'O';
            cellElement.innerHTML = 'O';
            cellElement.classList.add('o');

            // Verifica o resultado após a jogada da máquina
            const [isFinished, winnerSymbol] = verificarVencedor(localGameState);

            if (isFinished) {
                localGameActive = false;
                if (winnerSymbol === 'O') {
                    statusDisplay.innerHTML = `A máquina venceu!`;
                } else {
                    statusDisplay.innerHTML = `O jogo empatou!`;
                }
            } else {
                // Se o jogo não terminou, troca para a vez do jogador
                localCurrentPlayer = 'X';
                statusDisplay.innerHTML = `Sua vez (X)`;
            }
        }

        // Função compartilhada de verificação de vitória (mantida do seu código original)
        function verificarVencedor(board) {
            for (const condition of winningConditions) {
                const [a, b, c] = condition;
                if (board[a] && board[a] === board[b] && board[a] === board[c]) return [true, board[a]];
            }
            if (!board.includes('')) return [true, null]; // Empate
            return [false, null]; // Jogo continua
        }
    </script>
</body>
</html>
