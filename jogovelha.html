<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jogo da Velha - Online</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Estilos adicionais */
        #ranking-section { margin-bottom: 30px; text-align: center; }
        #ranking-board ol { list-style: none; padding: 0; }
        #ranking-board li { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid var(--cor-primaria); font-size: 1.1em; text-align: left; }
        #ranking-board li:last-child { border-bottom: none; }
        #game-code-display { margin: 20px 0; font-size: 1.2em; text-align: center; }
        #game-code-display span { background: #333; padding: 5px 10px; border-radius: 5px; cursor: pointer; }
        #join-game-section input { padding: 10px; font-size: 1em; margin-right: 10px; }
        #reset-button { margin-top: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Jogo da Velha Online</h1>

        <div id="ranking-section">
            <h2><i class="fas fa-trophy"></i> Ranking</h2>
            <div id="ranking-board">
                <p>Carregando ranking...</p>
            </div>
        </div>

        <div id="initial-view">
            <div id="create-game-section">
                <button class="btn" onclick="criarNovoJogo()">Criar Novo Jogo</button>
            </div>
            <hr style="margin: 20px 0;">
            <div id="join-game-section">
                <input type="text" id="game-code-input" placeholder="Cole o código do jogo aqui">
                <button class="btn secondary" onclick="entrarEmJogo()">Entrar no Jogo</button>
            </div>
            <a href="mural.html" class="btn secondary" style="margin-top: 20px;">Voltar ao Mural</a>
        </div>

        <div id="game-view" style="display: none;">
            <div id="game-code-display"></div>
            <div id="game-board"></div>
            <div id="status">Aguardando oponente...</div>
            <button id="reset-button" style="display:none;" onclick="location.reload()">Sair da Partida</button>
        </div>
    </div>

    <script>
        // --- INICIALIZAÇÃO E VARIÁVEIS GLOBAIS ---
        const supabaseUrl = 'https://ldrcfomamlzpxoucpkmb.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxkcmNmb21hbWx6cHhvdWNwa21iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE4MjA4MjksImV4cCI6MjA2NzM5NjgyOX0.jsqMGgsa9qOMVQvX7bdS70lFvJ7f7TEpm3ggEtV-tL0';
        const { createClient } = supabase;
        const _supabase = createClient(supabaseUrl, supabaseKey);

        const initialView = document.getElementById('initial-view');
        const gameView = document.getElementById('game-view');
        const gameBoard = document.getElementById('game-board');
        const statusDisplay = document.getElementById('status');
        const gameCodeDisplay = document.getElementById('game-code-display');
        const resetButton = document.getElementById('reset-button');
        // VARIÁVEIS DO RANKING (ADICIONADAS DE VOLTA)
        const rankingBoard = document.getElementById('ranking-board');
        const rankingSection = document.getElementById('ranking-section');

        let currentUser = null;
        let currentGame = null;
        let gameSubscription = null;

        const winningConditions = [
            [0, 1, 2], [3, 4, 5], [6, 7, 8],
            [0, 3, 6], [1, 4, 7], [2, 5, 8],
            [0, 4, 8], [2, 4, 6]
        ];

        // --- LÓGICA PRINCIPAL ---
        document.addEventListener('DOMContentLoaded', async () => {
            const { data: { session } } = await _supabase.auth.getSession();
            if (!session) {
                window.location.href = 'index.html';
                return;
            }
            currentUser = session.user;
            await carregarRanking(); // <-- CHAMADA DA FUNÇÃO DE RANKING RESTAURADA
        });

        // --- FUNÇÃO DO RANKING (ADICIONADA DE VOLTA) ---
        async function carregarRanking() {
            rankingBoard.innerHTML = '<p>Carregando ranking...</p>';
            const { data, error } = await _supabase
                .from('game_scores')
                .select(`wins, profiles(username)`)
                .order('wins', { ascending: false })
                .limit(5); // Pega os 5 melhores

            if (error) {
                console.error("Erro ao carregar ranking:", error);
                rankingBoard.innerHTML = '<p>Não foi possível carregar o ranking.</p>';
                return;
            }
            
            if (data.length === 0) {
                rankingBoard.innerHTML = '<p>Ninguém venceu ainda. Seja o primeiro!</p>';
                return;
            }
            
            const rankingList = document.createElement('ol');
            data.forEach((score, index) => {
                const playerUsername = score.profiles ? score.profiles.username : 'Anônimo';
                const listItem = document.createElement('li');
                listItem.innerHTML = `<span>#${index + 1} ${playerUsername}</span> <span>${score.wins} vitórias</span>`;
                rankingList.appendChild(listItem);
            });
            rankingBoard.innerHTML = '';
            rankingBoard.appendChild(rankingList);
        }

        // --- FUNÇÕES DO JOGO ONLINE ---
        async function criarNovoJogo() {
            const { data, error } = await _supabase
                .from('games')
                .insert({ player1_id: currentUser.id })
                .select().single();

            if (error) { console.error("Erro ao criar jogo:", error); return; }
            
            currentGame = data;
            iniciarVisualizacaoDeJogo();
            escutarMudancasNoJogo(currentGame.id);
        }

        async function entrarEmJogo() {
            const gameId = document.getElementById('game-code-input').value.trim();
            if (!gameId) { alert("Por favor, insira um código de jogo."); return; }
            
            const { data, error } = await _supabase
                .from('games')
                .update({ player2_id: currentUser.id, status: 'in_progress' })
                .eq('id', gameId)
                .eq('status', 'waiting')
                .is('player2_id', null)
                .select().single();

            if (error || !data) {
                console.error("Erro ao entrar no jogo:", error);
                alert("Código de jogo inválido ou o jogo já começou.");
                return;
            }

            currentGame = data;
            iniciarVisualizacaoDeJogo();
            escutarMudancasNoJogo(currentGame.id);
        }

        function iniciarVisualizacaoDeJogo() {
            initialView.style.display = 'none';
            rankingSection.style.display = 'none'; // <-- LÓGICA PARA ESCONDER O RANKING RESTAURADA
            gameView.style.display = 'block';
            gameCodeDisplay.innerHTML = `Código do Jogo: <span onclick="copiarCodigo()">${currentGame.id}</span> (clique para copiar)`;
            desenharTabuleiro();
            atualizarStatus();
        }

        function copiarCodigo() {
            navigator.clipboard.writeText(currentGame.id).then(() => alert("Código copiado!"));
        }

        function escutarMudancasNoJogo(gameId) {
            if (gameSubscription) { gameSubscription.unsubscribe(); }
            gameSubscription = _supabase
                .channel(`game-${gameId}`)
                .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'games', filter: `id=eq.${gameId}` }, payload => {
                    currentGame = payload.new;
                    desenharTabuleiro();
                    atualizarStatus();
                })
                .subscribe();
        }

        function desenharTabuleiro() {
            gameBoard.innerHTML = '';
            currentGame.board_state.forEach((cellValue, index) => {
                const cellElement = document.createElement('div');
                cellElement.classList.add('cell');
                if (cellValue) {
                    cellElement.classList.add(cellValue.toLowerCase());
                }
                cellElement.dataset.cellIndex = index;
                cellElement.textContent = cellValue;
                cellElement.addEventListener('click', () => fazerJogada(index));
                gameBoard.appendChild(cellElement);
            });
        }
        
        async function atualizarStatus() {
            if (currentGame.status === 'finished') {
                resetButton.style.display = 'block';
                if (currentGame.winner_id) {
                    const venci = currentUser.id === currentGame.winner_id;
                    statusDisplay.textContent = venci ? 'Você venceu!' : 'Você perdeu!';
                    // Se eu venci, chamo a função para registrar os pontos
                    if (venci) {
                        await _supabase.rpc('increment_wins', { user_id_to_update: currentUser.id });
                        // Não precisa chamar carregarRanking aqui, pois a tela vai recarregar para um novo jogo
                    }
                } else {
                    statusDisplay.textContent = 'O jogo empatou!';
                }
            } else if (currentGame.status === 'in_progress') {
                const isMyTurn = (currentGame.current_turn === 'X' && currentUser.id === currentGame.player1_id) ||
                                 (currentGame.current_turn === 'O' && currentUser.id === currentGame.player2_id);
                statusDisplay.textContent = isMyTurn ? 'É a sua vez!' : 'Aguardando jogada do oponente...';
            } else {
                 statusDisplay.textContent = 'Aguardando oponente...';
            }
        }

        async function fazerJogada(index) {
            const mySymbol = currentUser.id === currentGame.player1_id ? 'X' : 'O';
            if (currentGame.status !== 'in_progress' || mySymbol !== currentGame.current_turn || currentGame.board_state[index] !== '') {
                return;
            }

            const newBoardState = [...currentGame.board_state];
            newBoardState[index] = mySymbol;
            
            const [isFinished, winnerSymbol] = verificarVencedor(newBoardState);
            let newStatus = 'in_progress';
            let newWinnerId = null;
            if (isFinished) {
                newStatus = 'finished';
                if (winnerSymbol) {
                    newWinnerId = winnerSymbol === 'X' ? currentGame.player1_id : currentGame.player2_id;
                }
            }
            
            const nextTurn = mySymbol === 'X' ? 'O' : 'X';
            const updatePayload = {
                board_state: newBoardState,
                current_turn: nextTurn,
                status: newStatus,
                winner_id: newWinnerId
            };
            
            const { error } = await _supabase.from('games').update(updatePayload).eq('id', currentGame.id);
            if (error) console.error("Erro ao fazer jogada:", error);
        }

        function verificarVencedor(board) {
            for (const condition of winningConditions) {
                const [a, b, c] = condition;
                if (board[a] && board[a] === board[b] && board[a] === board[c]) {
                    return [true, board[a]];
                }
            }
            if (!board.includes('')) {
                return [true, null];
            }
            return [false, null];
        }
    </script>
</body>
</html>
