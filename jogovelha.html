<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jogo da Velha</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="background-animation"></div>
    <div class="floating-particles" id="particles-container"></div>

    <div class="container">
        <h1>Jogo da Velha</h1>

        <div id="ranking-section">
            <h2><i class="fas fa-trophy"></i> Ranking</h2>
            <div id="ranking-board">
                <p>Carregando ranking...</p>
            </div>
        </div>

        <div id="mode-selection">
            <button class="btn" onclick="startGame('computer')">Jogar contra a Máquina</button>
            <button class="btn secondary" onclick="startGame('player')">Jogar com um Oponente</button>
            <a href="mural.html" class="btn secondary" style="margin-top: 20px;">Voltar ao Mural</a>
        </div>

        <div id="game-content" style="display: none;">
            <div id="game-board">
                <div class="cell" data-cell-index="0"></div>
                <div class="cell" data-cell-index="1"></div>
                <div class="cell" data-cell-index="2"></div>
                <div class="cell" data-cell-index="3"></div>
                <div class="cell" data-cell-index="4"></div>
                <div class="cell" data-cell-index="5"></div>
                <div class="cell" data-cell-index="6"></div>
                <div class="cell" data-cell-index="7"></div>
                <div class="cell" data-cell-index="8"></div>
            </div>
            <div id="status"></div>
            <button id="reset-button">Reiniciar Jogo</button>
            <button class="btn secondary" style="margin-top: 20px;" onclick="location.reload()">Escolher outro modo</button>
        </div>
    </div>

    <script>
        // --- INICIALIZAÇÃO DO SUPABASE ---
        const supabaseUrl = 'https://ldrcfomamlzpxoucpkmb.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxkcmNmb21hbWx6cHhvdWNwa21iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE4MjA4MjksImV4cCI6MjA2NzM5NjgyOX0.jsqMGgsa9qOMVQvX7bdS70lFvJ7f7TEpm3ggEtV-tL0';
        const { createClient } = supabase;
        const _supabase = createClient(supabaseUrl, supabaseKey);
        let currentUser = null;

        // --- Lógica do Jogo da Velha ---
        const cells = document.querySelectorAll('.cell');
        const statusDisplay = document.getElementById('status');
        const resetButton = document.getElementById('reset-button');
        const modeSelection = document.getElementById('mode-selection');
        const gameContent = document.getElementById('game-content');
        const gameBoard = document.getElementById('game-board');
        const rankingBoard = document.getElementById('ranking-board');
        const rankingSection = document.getElementById('ranking-section'); // <-- CORREÇÃO 1: Variável adicionada

        let gameActive = true;
        let currentPlayer = 'X';
        let gameState = ['', '', '', '', '', '', '', '', ''];
        let gameMode = '';

        const winningConditions = [
            [0, 1, 2], [3, 4, 5], [6, 7, 8], [0, 3, 6], [1, 4, 7], [2, 5, 8], [0, 4, 8], [2, 4, 6]
        ];
        
        document.addEventListener('DOMContentLoaded', async () => {
            createParticles();
            const { data: { session } } = await _supabase.auth.getSession();
            currentUser = session?.user || null;
            await carregarRanking();
        });

        async function carregarRanking() {
            rankingBoard.innerHTML = '<p>Carregando ranking...</p>';
            const { data, error } = await _supabase
                .from('game_scores')
                .select(`wins, profiles(username, avatar_url)`)
                .order('wins', { ascending: false })
                .limit(10); 

            if (error) {
                console.error("Erro ao carregar ranking:", error);
                rankingBoard.innerHTML = '<p>Não foi possível carregar o ranking.</p>';
                return;
            }
            
            if (data.length === 0) {
                rankingBoard.innerHTML = '<p>Ninguém venceu ainda. Seja o primeiro!</p>';
                return;
            }
            
            const rankingList = document.createElement('ol');
            data.forEach((score, index) => {
                const playerUsername = score.profiles ? score.profiles.username : 'Anônimo';
                const listItem = document.createElement('li');
                listItem.innerHTML = `<span>${index + 1}. ${playerUsername}</span> <span>${score.wins} vitórias</span>`;
                rankingList.appendChild(listItem);
            });
            rankingBoard.innerHTML = '';
            rankingBoard.appendChild(rankingList);
        }

        async function registrarVitoria() {
            if (!currentUser || currentPlayer !== 'X') {
                return;
            }
            statusDisplay.innerHTML = `Você venceu! Pontos registrados!`;
            const { error } = await _supabase.rpc('increment_wins', {
                user_id_to_update: currentUser.id
            });
            if (error) {
                console.error('Erro ao registrar vitória:', error);
            } else {
                console.log('Vitória registrada com sucesso!');
                await carregarRanking();
            }
        }

        function startGame(mode) {
            gameMode = mode;
            modeSelection.style.display = 'none';
            rankingSection.style.display = 'none'; // <-- CORREÇÃO 2: Linha adicionada
            gameContent.style.display = 'block';
            gameBoard.style.display = 'grid';
            resetButton.style.display = 'block';
            handleRestartGame();
        }
        
        function handleResultValidation() {
            let roundWon = false;
            for (let i = 0; i < winningConditions.length; i++) {
                const winCondition = winningConditions[i];
                let a = gameState[winCondition[0]], b = gameState[winCondition[1]], c = gameState[winCondition[2]];
                if (a === '' || b === '' || c === '') continue;
                if (a === b && b === c) { roundWon = true; break; }
            }

            if (roundWon) {
                gameActive = false;
                if (gameMode === 'computer' && currentPlayer === 'X') {
                    registrarVitoria();
                } else {
                    statusDisplay.innerHTML = `O jogador ${currentPlayer} venceu!`;
                }
                return;
            }

            if (!gameState.includes('')) {
                statusDisplay.innerHTML = `O jogo empatou!`;
                gameActive = false;
                return;
            }

            handlePlayerChange();
        }

        // --- Funções do Jogo (mantidas como estão) ---
        function handleCellPlayed(clickedCell, clickedCellIndex) {
            if (gameState[clickedCellIndex] === '' && gameActive) {
                gameState[clickedCellIndex] = currentPlayer;
                clickedCell.innerHTML = currentPlayer;
                clickedCell.classList.add(currentPlayer.toLowerCase());
                handleResultValidation();
            }
        }
        function handlePlayerChange() {
            currentPlayer = currentPlayer === 'X' ? 'O' : 'X';
            statusDisplay.innerHTML = `É a vez do jogador ${currentPlayer}`;
            if (gameActive && currentPlayer === 'O' && gameMode === 'computer') {
                setTimeout(makeComputerMove, 700);
            }
        }
        function handleCellClick(event) {
            const clickedCell = event.target;
            const clickedCellIndex = parseInt(clickedCell.getAttribute('data-cell-index'));
            if (gameMode === 'player' || (gameMode === 'computer' && currentPlayer === 'X')) {
                handleCellPlayed(clickedCell, clickedCellIndex);
            }
        }
        function handleRestartGame() {
            gameActive = true;
            currentPlayer = 'X';
            gameState = ['', '', '', '', '', '', '', '', ''];
            statusDisplay.innerHTML = `É a vez do jogador ${currentPlayer}`;
            cells.forEach(cell => {
                cell.innerHTML = '';
                cell.classList.remove('x', 'o');
            });
        }
        function makeComputerMove() {
            const emptyCells = [];
            for (let i = 0; i < gameState.length; i++) { if (gameState[i] === '') emptyCells.push(i); }
            if (emptyCells.length === 0) { handleResultValidation(); return; }
            
            // Lógica da IA simplificada para o exemplo
            let bestMove = -1; 
            const randomIndex = Math.floor(Math.random() * emptyCells.length);
            bestMove = emptyCells[randomIndex];
            
            if (bestMove !== -1) {
                const cellToPlay = document.querySelector(`.cell[data-cell-index="${bestMove}"]`);
                handleCellPlayed(cellToPlay, bestMove);
            }
        }
        cells.forEach(cell => cell.addEventListener('click', handleCellClick));
        resetButton.addEventListener('click', handleRestartGame);
        function createParticles() {
             const particlesContainer = document.getElementById('particles-container');
             if(!particlesContainer) return;
             const numberOfParticles = 50;
             for (let i = 0; i < numberOfParticles; i++) {
                 const particle = document.createElement('div');
                 particle.classList.add('particle');
                 particle.style.left = `${Math.random() * 100}vw`;
                 particle.style.animationDuration = `${Math.random() * 10 + 10}s`;
                 particle.style.animationDelay = `${Math.random() * -20}s`;
                 particle.style.width = `${Math.random() * 3 + 2}px`;
                 particle.style.height = particle.style.width;
                 particlesContainer.appendChild(particle);
             }
        }
    </script>
</body>
</html>
