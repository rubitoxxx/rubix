<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jogo da Velha - Online</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Estilos adicionais para o modo online */
        #game-code-display { margin: 20px 0; font-size: 1.2em; }
        #game-code-display span { background: #333; padding: 5px 10px; border-radius: 5px; cursor: pointer; }
        #join-game-section input { padding: 10px; font-size: 1em; margin-right: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Jogo da Velha Online</h1>

        <div id="initial-view">
            <div id="create-game-section">
                <button class="btn" onclick="criarNovoJogo()">Criar Novo Jogo</button>
            </div>
            <hr style="margin: 20px 0;">
            <div id="join-game-section">
                <input type="text" id="game-code-input" placeholder="Cole o código do jogo aqui">
                <button class="btn secondary" onclick="entrarEmJogo()">Entrar no Jogo</button>
            </div>
            <a href="mural.html" class="btn secondary" style="margin-top: 20px;">Voltar ao Mural</a>
        </div>

        <div id="game-view" style="display: none;">
            <div id="game-code-display"></div>
            <div id="game-board">
                </div>
            <div id="status">Aguardando oponente...</div>
            <button id="reset-button" style="display:none;">Jogar Novamente</button>
        </div>
    </div>

    <script>
        // --- INICIALIZAÇÃO E VARIÁVEIS GLOBAIS ---
        const supabaseUrl = 'https://ldrcfomamlzpxoucpkmb.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxkcmNmb21hbWx6cHhvdWNwa21iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE4MjA4MjksImV4cCI6MjA2NzM5NjgyOX0.jsqMGgsa9qOMVQvX7bdS70lFvJ7f7TEpm3ggEtV-tL0';
        const { createClient } = supabase;
        const _supabase = createClient(supabaseUrl, supabaseKey);

        const initialView = document.getElementById('initial-view');
        const gameView = document.getElementById('game-view');
        const gameBoard = document.getElementById('game-board');
        const statusDisplay = document.getElementById('status');
        const gameCodeDisplay = document.getElementById('game-code-display');

        let currentUser = null;
        let currentGame = null;
        let gameSubscription = null;

        // --- LÓGICA PRINCIPAL ---
        document.addEventListener('DOMContentLoaded', async () => {
            const { data: { session } } = await _supabase.auth.getSession();
            if (!session) {
                window.location.href = 'index.html';
                return;
            }
            currentUser = session.user;
        });

        async function criarNovoJogo() {
            const { data, error } = await _supabase
                .from('games')
                .insert({ player1_id: currentUser.id })
                .select()
                .single();

            if (error) {
                console.error("Erro ao criar jogo:", error);
                return;
            }
            
            currentGame = data;
            iniciarVisualizacaoDeJogo();
            escutarMudancasNoJogo(currentGame.id);
        }

        async function entrarEmJogo() {
            const gameId = document.getElementById('game-code-input').value.trim();
            if (!gameId) {
                alert("Por favor, insira um código de jogo.");
                return;
            }

            // Atualiza o jogo para adicionar o player 2 e mudar o status
            const { data, error } = await _supabase
                .from('games')
                .update({ player2_id: currentUser.id, status: 'in_progress' })
                .eq('id', gameId)
                .select()
                .single();

            if (error || !data) {
                console.error("Erro ao entrar no jogo:", error);
                alert("Código de jogo inválido ou o jogo já começou.");
                return;
            }

            currentGame = data;
            iniciarVisualizacaoDeJogo();
            escutarMudancasNoJogo(currentGame.id);
        }

        function iniciarVisualizacaoDeJogo() {
            initialView.style.display = 'none';
            gameView.style.display = 'block';
            gameCodeDisplay.innerHTML = `Código do Jogo: <span onclick="copiarCodigo()">${currentGame.id}</span> (clique para copiar)`;
            desenharTabuleiro();
            atualizarStatus();
        }

        function copiarCodigo() {
            navigator.clipboard.writeText(currentGame.id)
                .then(() => alert("Código copiado para a área de transferência!"));
        }

        // A MÁGICA DO REALTIME!
        function escutarMudancasNoJogo(gameId) {
            if (gameSubscription) {
                gameSubscription.unsubscribe();
            }
            gameSubscription = _supabase
                .channel(`game-${gameId}`)
                .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'games', filter: `id=eq.${gameId}` }, payload => {
                    console.log('Mudança recebida!', payload.new);
                    currentGame = payload.new;
                    desenharTabuleiro();
                    atualizarStatus();
                })
                .subscribe();
        }

        function desenharTabuleiro() {
            gameBoard.innerHTML = ''; // Limpa o tabuleiro
            currentGame.board_state.forEach((cellValue, index) => {
                const cellElement = document.createElement('div');
                cellElement.classList.add('cell');
                cellElement.dataset.cellIndex = index;
                cellElement.textContent = cellValue;
                cellElement.addEventListener('click', () => fazerJogada(index));
                gameBoard.appendChild(cellElement);
            });
        }
        
        function atualizarStatus() {
            if (currentGame.status === 'waiting') {
                statusDisplay.textContent = 'Aguardando oponente...';
            } else if (currentGame.status === 'in_progress') {
                const isMyTurn = (currentGame.current_turn === 'X' && currentUser.id === currentGame.player1_id) ||
                                 (currentGame.current_turn === 'O' && currentUser.id === currentGame.player2_id);
                statusDisplay.textContent = isMyTurn ? 'É a sua vez!' : 'Aguardando jogada do oponente...';
            } else if (currentGame.status === 'finished') {
                if (currentGame.winner_id) {
                    statusDisplay.textContent = currentUser.id === currentGame.winner_id ? 'Você venceu!' : 'Você perdeu!';
                } else {
                    statusDisplay.textContent = 'O jogo empatou!';
                }
            }
        }

        async function fazerJogada(index) {
            // Validações
            const mySymbol = currentUser.id === currentGame.player1_id ? 'X' : 'O';
            if (currentGame.status !== 'in_progress' || mySymbol !== currentGame.current_turn || currentGame.board_state[index] !== '') {
                return; // Não é sua vez ou a célula já está ocupada
            }

            // Atualiza o estado do tabuleiro localmente
            const newBoardState = [...currentGame.board_state];
            newBoardState[index] = mySymbol;
            
            // Verifica se há um vencedor ou empate
            const [isFinished, winnerSymbol] = verificarVencedor(newBoardState);
            let newStatus = 'in_progress';
            let newWinnerId = null;
            if (isFinished) {
                newStatus = 'finished';
                if (winnerSymbol) {
                    newWinnerId = winnerSymbol === 'X' ? currentGame.player1_id : currentGame.player2_id;
                }
            }
            
            // Prepara a atualização para o banco
            const nextTurn = mySymbol === 'X' ? 'O' : 'X';
            const updatePayload = {
                board_state: newBoardState,
                current_turn: nextTurn,
                status: newStatus,
                winner_id: newWinnerId
            };
            
            // Envia a jogada para o Supabase
            const { error } = await _supabase
                .from('games')
                .update(updatePayload)
                .eq('id', currentGame.id);
            
            if (error) console.error("Erro ao fazer jogada:", error);
        }

        function verificarVencedor(board) {
            for (const condition of winningConditions) {
                const [a, b, c] = condition;
                if (board[a] && board[a] === board[b] && board[a] === board[c]) {
                    return [true, board[a]]; // [terminou, simbolo_vencedor]
                }
            }
            if (!board.includes('')) {
                return [true, null]; // [terminou, sem_vencedor (empate)]
            }
            return [false, null]; // [nao_terminou, sem_vencedor]
        }
       // NOVO CÓDIGO PARA DIAGNÓSTICO - SUBSTITUA A FUNÇÃO ANTIGA POR ESTA
async function entrarEmJogo() {
    const gameId = document.getElementById('game-code-input').value.trim();
    if (!gameId) {
        alert("Por favor, insira um código de jogo.");
        return;
    }

    try {
        // ETAPA 1: TENTAR ENCONTRAR O JOGO PRIMEIRO
        console.log(`Procurando pelo jogo com ID: ${gameId}`);
        const { data: gameData, error: findError } = await _supabase
            .from('games')
            .select('*')
            .eq('id', gameId)
            .eq('status', 'waiting')
            .is('player2_id', null)
            .single();

        // Se não encontrar um jogo aberto, o erro acontece aqui.
        if (findError || !gameData) {
            console.error("ERRO DE DIAGNÓSTICO (ETAPA 1 - ENCONTRAR):", findError);
            alert("Não foi possível encontrar um jogo aberto com este código. Verifique se o código está correto e se o jogo já não foi iniciado por outra pessoa.");
            return;
        }

        console.log("Jogo encontrado e está aberto! Tentando entrar...", gameData);

        // ETAPA 2: TENTAR ATUALIZAR O JOGO PARA O JOGADOR 2 ENTRAR
        const { data: updateData, error: updateError } = await _supabase
            .from('games')
            .update({ player2_id: currentUser.id, status: 'in_progress' })
            .eq('id', gameId)
            .select()
            .single();

        // Se a permissão de UPDATE falhar, o erro acontece aqui.
        if (updateError || !updateData) {
            console.error("ERRO DE DIAGNÓSTICO (ETAPA 2 - ENTRAR):", updateError);
            alert("Encontramos o jogo, mas um erro de permissão (RLS) impediu a entrada. Verifique a política de UPDATE na tabela 'games'.");
            return;
        }

        // Se tudo deu certo:
        console.log("Entrou no jogo com sucesso!");
        currentGame = updateData;
        iniciarVisualizacaoDeJogo();
        escutarMudancasNoJogo(currentGame.id);

    } catch (e) {
        console.error("Um erro inesperado ocorreu:", e);
        alert("Ocorreu um erro inesperado.");
    }
}
    </script>
</body>
</html>
